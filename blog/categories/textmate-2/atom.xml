<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: TextMate 2 | Lester Zhao's Blog]]></title>
  <link href="http://lester.izstudy.com/blog/categories/textmate-2/atom.xml" rel="self"/>
  <link href="http://lester.izstudy.com/"/>
  <updated>2014-01-15T17:08:58+08:00</updated>
  <id>http://lester.izstudy.com/</id>
  <author>
    <name><![CDATA[Lester Zhao]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[TextMate 2 下 Ctag 和 Git Bundle 同时工作]]></title>
    <link href="http://lester.izstudy.com/blog/2013/10/21/ctag-and-git-bundles-of-textmate-2-both-work-fine-at-the-same-time/"/>
    <updated>2013-10-21T00:20:00+08:00</updated>
    <id>http://lester.izstudy.com/blog/2013/10/21/ctag-and-git-bundles-of-textmate-2-both-work-fine-at-the-same-time</id>
    <content type="html"><![CDATA[<p>最近再使用 TextMate 2 的 Bundle：Ctag 和 Git 的时候经过了一番周折才勉强可以让这两个 Bundle 同时工作。写出来帮助遇到同样问题的朋友。避免浪费时间。</p>

<p>问题现象：</p>

<p>使用 TM2、 ruby 1.9.3 或 ruby 2.0.1</p>

<p>Git Bundle 可以正常工作。</p>

<p>安装 TM Ctag Bundle 之后 ^ + Command + P 报异常大概如下:</p>

<p>{% codeblock lang:ruby %}</p>

<pre><code>ui.rb:308: in `to_plist': An object in the argument tree could not be converted (ArgumentError)
    from ～/Library/Application Support/TextMate/Managed/Bundles/Bundle Support.tmbundle/Support/shared/lib/ui.rb:308:in `block in initialize'
    from ～/Library/Application Support/TextMate/Managed/Bundles/Bundle Support.tmbundle/Support/shared/lib/ui.rb:307:in `popen'
    from ～/Library/Application Support/TextMate/Managed/Bundles/Bundle Support.tmbundle/Support/shared/lib/ui.rb:307:in `initialize'
    from ～/Library/Application Support/TextMate/Managed/Bundles/Bundle Support.tmbundle/Support/shared/lib/ui.rb:20:in `new'
    from ～/Library/Application Support/TextMate/Managed/Bundles/Bundle Support.tmbundle/Support/shared/lib/ui.rb:20:in `dialog'
    from ～/Library/Application Support/TextMate/Managed/Bundles/Bundle Support.tmbundle/Support/shared/lib/progress.rb:42:in `call_with_progress'
    from ～/_test_tm.rb:12:in `&lt;main&gt;'
</code></pre>

<p>{% endcodeblock %}</p>

<p>其中关键是: ui.rb:308: in `to_plist': An object in the argument tree could not be converted
如果你的异常是这个那么可以肯定的时候和我的情况一直。下面是我的一个临时解决方案。</p>

<!--more-->


<p>这个 bug 的解决有争议，TextMate 社区认为是 Ruby 的 bug，但网络上另一个解决方案认为是 TextMate 的 bug。</p>

<p>{% codeblock lang:bash %}
cd ~/Library/Application Support/TextMate/Managed/Bundles/Bundle Support.tmbundle/Support/shared/lib/osx
git clone git://github.com/kballard/osx-plist.git
cd osx-plist/ext/plist
ruby extconf.rb &amp;&amp; make
cd ../../../
mv plist.bundle plist.bundle.old
cp osx-plist/ext/plist/plist.bundle ./plist.bundle
{% endcodeblock %}</p>

<p>这样Ctag是可以正常运行的，但是会导致 Git Bundle 报错：</p>

<p>{% codeblock lang:bash %}
dyld: lazy symbol binding failed: Symbol not found: <em>rb_intern2 Referenced from: ～/Library/Application Support/TextMate/Managed/Bundles/Bundle Support.tmbundle/Support/shared/lib/osx/plist.bundle Expected in: flat namespace
dyld: Symbol not found: </em>rb_intern2 Referenced from: ～/Library/Application Support/TextMate/Managed/Bundles/Bundle Support.tmbundle/Support/shared/lib/osx/plist.bundle Expected in: flat namespace
{% endcodeblock %}</p>

<p>我的一个临时解决方案是：</p>

<p>{% codeblock lang:bash %}
cd ~/Library/Application Support/TextMate/Managed/Bundles/Bundle Support.tmbundle/Support/shared/lib/osx
git clone git://github.com/kballard/osx-plist.git
cd osx-plist/ext/plist
{% endcodeblock %}</p>

<p>打开 osx-plist/ext/plist 下的 plist.c 找到：</p>

<p>{% codeblock lang:c %}
/<em>
 * Document-class: OSX::PropertyListError
 </em>/
void Init_plist() {</p>

<pre><code>mOSX = rb_define_module("OSX");
mPlist = rb_define_module_under(mOSX, "PropertyList");
</code></pre>

<p>{% endcodeblock %}</p>

<p>将 <code>void Init_plist() {</code> 改为 <code>void Init_plist2() {</code> 后执行：</p>

<p>{% codeblock lang:bash %}
ruby extconf.rb &amp;&amp; make
cd ../../../
mv plist.bundle.old plist.bundle
cp osx-plist/ext/plist/plist.bundle ./plist2.bundle
{% endcodeblock %}</p>

<p>找到 TM Ctag 的安装目录，我的是： ～/Library/Application Support/Avian/Pristine Copy/Bundles/tm-ctags.tmbundle/Support/bin
修改 tmctags.rb 和 update_ctags.rb
分别在 <code>require ENV['TM_SUPPORT_PATH'] + '/lib/ui.rb'</code> 前增加：</p>

<p><code>require ENV['TM_SUPPORT_PATH'] + '/lib/osx/plist2'</code></p>

<p>这样就可以同时工作了  但是还是会有一个警告消息。</p>

<p>完美的解决方案是修改 原版的 plist.bundle 或者 完善 git://github.com/kballard/osx-plist.git</p>

<p>简单研究了一下 TM2的源码 目前我还不会修改 plist.bundle 所以只能使用这个临时不完美的解决方案。</p>

<p>这个方案的原理是：
先载入新版本的 plist2 ，之后原版的plist就无法加载。但是会有一个警告消息。</p>
]]></content>
  </entry>
  
</feed>
